# Variables
ENV_NAME=dcleaderboard
# DÃ©tecter le chemin de conda automatiquement
CONDA_BASE := $(shell if [ -d "$$HOME/anaconda3" ]; then echo "$$HOME/anaconda3"; elif [ -d "$$HOME/miniconda3" ]; then echo "$$HOME/miniconda3"; elif [ -d "/opt/conda" ]; then echo "/opt/conda"; else conda info --base 2>/dev/null || echo ""; fi)
CONDA_ACTIVATE=bash -c "source $(CONDA_BASE)/etc/profile.d/conda.sh && conda activate $(ENV_NAME)"

.PHONY: all clean html install check-env update-env remove-env

# VÃ©rifier que Conda est installÃ©
check-conda:
@if [ -z "$(CONDA_BASE)" ] || [ ! -f "$(CONDA_BASE)/etc/profile.d/conda.sh" ]; then \
echo "âŒ Conda n'est pas installÃ© ou introuvable."; \
echo "ğŸ” Chemins vÃ©rifiÃ©s: ~/anaconda3, ~/miniconda3, /opt/conda"; \
echo "ğŸ’¡ Installez Anaconda ou Miniconda, ou assurez-vous que conda est dans le PATH."; \
exit 1; \
else \
echo "âœ… Conda trouvÃ© dans: $(CONDA_BASE)"; \
fi

# CrÃ©er l'environnement conda
create-env: check-conda
@echo "ğŸ“¦ CrÃ©ation de l'environnement conda $(ENV_NAME)..."
$(CONDA_BASE)/bin/conda env create -f environment.yml
@echo "âœ… Environnement $(ENV_NAME) crÃ©Ã© avec succÃ¨s!"

# Mettre Ã  jour l'environnement existant
update-env: check-conda
@echo "ğŸ”„ Mise Ã  jour de l'environnement conda $(ENV_NAME)..."
$(CONDA_BASE)/bin/conda env update -f environment.yml --prune
@echo "âœ… Environnement $(ENV_NAME) mis Ã  jour!"

# Installer/mettre Ã  jour l'environnement
install: check-conda
@if $(CONDA_BASE)/bin/conda env list | grep -q "^$(ENV_NAME) "; then \
echo "ğŸ”„ L'environnement $(ENV_NAME) existe dÃ©jÃ , mise Ã  jour..."; \
$(MAKE) -f Makefile.conda update-env; \
else \
echo "ğŸ“¦ CrÃ©ation de l'environnement $(ENV_NAME)..."; \
$(MAKE) -f Makefile.conda create-env; \
fi

# VÃ©rifier que l'environnement est prÃªt
check-env: install
@echo "ğŸ” VÃ©rification de l'environnement..."
@bash -c "source $(CONDA_BASE)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && python -c 'import pandas, numpy, json, matplotlib; print(\"âœ… DÃ©pendances Python OK\")'"

# Compiler le leaderboard
html:
@echo "ğŸ› ï¸ GÃ©nÃ©ration du site..."
@bash -c "source $(CONDA_BASE)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && export PYTHONPATH=$$(pwd)/.. && python -m dcleaderboard.build --results-dir results --output-dir _site"
@echo "âœ… Compilation terminÃ©e! Fichiers gÃ©nÃ©rÃ©s dans _site/"

# Cible principale
all: html

# Test de l'environnement
test-env: check-env
@echo "ğŸ§ª Test de l'environnement conda..."
@bash -c "source $(CONDA_BASE)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && python --version"
@bash -c "source $(CONDA_BASE)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && pip list | grep -E '(pandas|numpy)'"

# Supprimer l'environnement
remove-env: check-conda
@echo "ğŸ—‘ï¸ Suppression de l'environnement $(ENV_NAME)..."
$(CONDA_BASE)/bin/conda env remove -n $(ENV_NAME) -y
@echo "âœ… Environnement supprimÃ©!"

# Nettoyer les fichiers gÃ©nÃ©rÃ©s
clean:
@echo "ğŸ§¹ Nettoyage des fichiers gÃ©nÃ©rÃ©s..."
rm -rf _site/
@echo "âœ… Nettoyage terminÃ©!"
