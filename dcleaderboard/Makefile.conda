# Variables
ENV_NAME=dcleaderboard
CONDA_ACTIVATE=bash -c "source $$(conda info --base)/etc/profile.d/conda.sh && conda activate $(ENV_NAME)"
INPUT_QMD=leaderboard.qmd
ABOUT_QMD=about.qmd
OUTPUT_HTML=leaderboard.html
ABOUT_HTML=about.html

.PHONY: all clean html install check-env update-env remove-env

# VÃ©rifier que Conda est installÃ©
check-conda:
	@command -v conda >/dev/null 2>&1 || { echo "âŒ Conda n'est pas installÃ©. Installez Anaconda ou Miniconda."; exit 1; }

# CrÃ©er l'environnement conda
create-env: check-conda
	@echo "ğŸ“¦ CrÃ©ation de l'environnement conda $(ENV_NAME)..."
	conda env create -f environment.yml
	@echo "âœ… Environnement $(ENV_NAME) crÃ©Ã© avec succÃ¨s!"

# Mettre Ã  jour l'environnement existant
update-env: check-conda
	@echo "ğŸ”„ Mise Ã  jour de l'environnement conda $(ENV_NAME)..."
	conda env update -f environment.yml --prune
	@echo "âœ… Environnement $(ENV_NAME) mis Ã  jour!"

# Installer/mettre Ã  jour l'environnement
install: check-conda
	@if conda env list | grep -q "^$(ENV_NAME) "; then \
		echo "ğŸ”„ L'environnement $(ENV_NAME) existe dÃ©jÃ , mise Ã  jour..."; \
		$(MAKE) -f Makefile.conda update-env; \
	else \
		echo "ğŸ“¦ CrÃ©ation de l'environnement $(ENV_NAME)..."; \
		$(MAKE) -f Makefile.conda create-env; \
	fi

# VÃ©rifier que l'environnement est prÃªt
check-env: install
	@echo "ğŸ” VÃ©rification de l'environnement..."
	@bash -c "source $$(conda info --base)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && python -c 'import pandas, numpy, json, matplotlib; print(\"âœ… DÃ©pendances Python OK\")'"
	@bash -c "source $$(conda info --base)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && python -c 'import jupyter, nbformat, IPython; print(\"âœ… Jupyter OK\")'"

# Compiler le leaderboard
html: check-env
	@echo "ğŸ› ï¸ Compilation Quarto..."
	@bash -c "source $$(conda info --base)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && quarto render $(INPUT_QMD) --to html"
	@echo "ğŸ› ï¸ Compilation de la page About..."
	@bash -c "source $$(conda info --base)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && quarto render $(ABOUT_QMD) --to html"
	@echo "âœ… Compilation terminÃ©e! Fichiers gÃ©nÃ©rÃ©s:"
	@echo "   - $(OUTPUT_HTML)"
	@echo "   - $(ABOUT_HTML)"

# Cible principale
all: html

# Test de l'environnement
test-env: check-env
	@echo "ğŸ§ª Test de l'environnement conda..."
	@bash -c "source $$(conda info --base)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && python --version"
	@bash -c "source $$(conda info --base)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && which python"
	@bash -c "source $$(conda info --base)/etc/profile.d/conda.sh && conda activate $(ENV_NAME) && pip list | grep -E '(pandas|numpy|jupyter|quarto)'"

# Supprimer l'environnement
remove-env: check-conda
	@echo "ğŸ—‘ï¸ Suppression de l'environnement $(ENV_NAME)..."
	conda env remove -n $(ENV_NAME) -y
	@echo "âœ… Environnement supprimÃ©!"

# Nettoyer les fichiers gÃ©nÃ©rÃ©s
clean:
	@echo "ğŸ§¹ Nettoyage des fichiers gÃ©nÃ©rÃ©s..."
	rm -f $(OUTPUT_HTML) $(ABOUT_HTML)
	rm -rf _site/
	@echo "âœ… Nettoyage terminÃ©!"

# Aide
help:
	@echo "ğŸ“‹ Commandes disponibles:"
	@echo "  make install     - CrÃ©er/mettre Ã  jour l'environnement conda"
	@echo "  make all         - Compiler le leaderboard (cible par dÃ©faut)"
	@echo "  make html        - Compiler uniquement le HTML"
	@echo "  make test-env    - Tester l'environnement"
	@echo "  make clean       - Nettoyer les fichiers gÃ©nÃ©rÃ©s"
	@echo "  make remove-env  - Supprimer complÃ¨tement l'environnement"
	@echo "  make help        - Afficher cette aide"
